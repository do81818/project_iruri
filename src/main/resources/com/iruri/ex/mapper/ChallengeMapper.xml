<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iruri.ex.mapper.ChallengeMapper">

	<resultMap type="com.iruri.ex.vo.IClassVO" id="iClassMap">
		<result property="classId" column="CLASS_ID"/>
		<result property="classTitle" column="CLASS_TITLE"/>
		<result property="classContent" column="CLASS_CONTENT"/>
		<result property="classGoal" column="CLASS_GOAL"/>
		<result property="classExerciseCount" column="CLASS_EXERCISECOUNT"/>
		<result property="classStartDate" column="CLASS_STARTDATE"/>
		<result property="classEndDate" column="CLASS_ENDDATE"/>
		<result property="classImage" column="CLASS_IMAGE"/>
		<result property="classLike" column="CLASS_LIKE"/>
		<result property="classState" column="CLASS_STATE"/>
		<result property="classHit" column="CLASS_HIT"/>
		<result property="classJoinMember" column="CLASS_JOINMEMBER"/>
		<result property="classTrainerInfo" column="CLASS_TRAINERINFO"/>
		<result property="classTotalMember" column="CLASS_TOTALMEMBER"/>
		<result property="classPrice" column="CLASS_PRICE"/>
		<result property="classNeed" column="CLASS_NEED"/>
		<result property="categoryId" column="CATEGORY_ID"/>
		<result property="classLevel" column="CLASS_LEVEL"/>
		<result property="rnum" column="rnum"/>		
		<association property="iUserVO" column="USER_ID" javaType="com.iruri.ex.vo.IUserVO" resultMap="com.iruri.ex.mapper.IUserMapper.iUserMap" />
		<collection property="exerciseDateList" resultMap="exerciseDateMap">
		</collection>
		<collection property="exerciseKindList" resultMap="exerciseKindMap">
		</collection>
		<collection property="likeListList" resultMap="likeListMap">
		</collection>
	</resultMap>


	<resultMap type="com.iruri.ex.vo.ExerciseDateVO" id="exerciseDateMap">
		<result property="exerciseDate" column="EXERCISE_DATE"/>
		<result property="classId" column="CLASS_ID"/>
	</resultMap>
	
	<resultMap type="com.iruri.ex.vo.ExerciseKindVO" id="exerciseKindMap">
		<result property="exerciseKind" column="EXERCISE_KIND"/>
		<result property="classId" column="CLASS_ID"/>
	</resultMap>
	
	<resultMap type="com.iruri.ex.vo.LikeListVO" id="likeListMap">
		<result property="likeListId" column="LIKELIST_ID"/>
		<result property="userId" column="USER_ID"/>
		<result property="classId" column="CLASS_ID"/>
		<result property="boardId" column="BOARD_ID"/>
		<result property="rnum" column="rnum"/>	
	</resultMap>
	<!-- 로그인 한 유저 클래스 정보 뽑아오기 -->
	<!--
	<select id="selectAll" resultMap="iClassMap">
		<![CDATA[
		SELECT
			*
		FROM 
			iclass
		WHERE
			user_id = #{userId}
		]]>
	</select>
	
	
	
	<select id="classcount" parameterType="int" resultType="int">
		<![CDATA[
		SELECT
			count(*)
		FROM
			iclass
		WHERE
			user_id = #{userId} 
		
			
		]]> 
	</select>
    -->
    
    
	<!-- 챌린지 메인 리스트 뽑기 -->
	<select id="ChallengeSelectAll" resultMap="iClassMap">
		<![CDATA[
		SELECT
			*
		FROM 
			iclass
		WHERE
			CATEGORY_ID = 1
		]]>
	</select>
	
	
	
	<!-- 챌린지 개설 시 폼 값 입력 -->
	<insert id="insertChallenge">
	<![CDATA[
		INSERT ALL
    into iclass(CLASS_ID, CLASS_TITLE, CLASS_CONTENT, CLASS_GOAL, CLASS_EXERCISECOUNT, CLASS_STARTDATE, 
    CLASS_ENDDATE, CLASS_IMAGE, CLASS_LIKE, CLASS_STATE, CLASS_HIT, CLASS_JOINMEMBER, CLASS_TRAINERINFO, 
    CLASS_TOTALMEMBER, CLASS_PRICE, CLASS_NEED, CATEGORY_ID, USER_ID, CLASS_LEVEL) 
    values ((SELECT NVL(MAX(class_id), MAX(class_id)) + 1 FROM iclass), #{classTitle}, #{classContent}, #{classGoal}, #{classExerciseCount}, #{classStartDate}, 
    		#{classEndDate},#{classImage}, #{classLike}, #{classState}, #{classHit}, #{classJoinMember}, #{classTrainerInfo}, 
    		#{classTotalMember}, #{classPrice}, #{classNeed}, #{categoryId}, #{userId}, #{classLevel})
          
     INTO EXERCISE_KIND(exercise_kind, CLASS_ID)
    VALUES ('요가' ,(SELECT NVL(MAX(class_id), MAX(class_id)) + 1 FROM iclass))
    INTO EXERCISE_KIND(exercise_kind, CLASS_ID)
    VALUES ('필라테스',(SELECT NVL(MAX(class_id), MAX(class_id)) + 1 FROM iclass))
    
    
    INTO EXERCISE_date(exercise_date, CLASS_ID)
    VALUES ('화',(SELECT NVL(MAX(class_id), MAX(class_id)) + 1 FROM iclass))
    INTO EXERCISE_date(exercise_date, CLASS_ID)
    VALUES ('목',(SELECT NVL(MAX(class_id), MAX(class_id)) + 1 FROM iclass)) 
    
	SELECT *  FROM DUAL
	]]>
	</insert>
	
	<!--전체 챌린지 -->
	<select id="getTotalCount_challenge" resultType="int">
	<![CDATA[
		select count(*) from iclass where category_id = 1 and CLASS_ENDDATE >= sysdate
	]]>
	</select>


	<select id="getListWithPaging_challenge" resultMap="iClassMap">
	<![CDATA[
	SELECT * FROM (
    SELECT ROWNUM AS RNUM, A.* FROM (
        SELECT * FROM iclass where category_id = 1 and class_id > 0 and CLASS_ENDDATE >= sysdate order by class_id desc
             ) A WHERE ROWNUM <= #{pageNum} * #{amount}
         ) WHERE RNUM > (#{pageNum}-1) * #{amount}
	]]>
	</select>
	
	
   <!--지난 챌린지 -->
   <select id="getTotalCount_challengeEndList"  resultType="int">
	<![CDATA[
		select count(*) from iclass where category_id = 1 and CLASS_ENDDATE < sysdate
	]]>
	
		<if test="keyword != null">
                   where CLASS_TITLE like '%'|| #{keyword} ||'%'
        </if>
        
	</select>


	<select id="getListWithPaging_challengeEndList" parameterType="HashMap" resultMap="iClassMap">
	<![CDATA[
	SELECT * FROM (
    SELECT ROWNUM AS RNUM, A.* FROM (
        SELECT * FROM iclass where category_id = 1 and class_id > 0 and CLASS_ENDDATE < sysdate order by class_enddate desc
             ) A WHERE ROWNUM <= #{pageNum} * #{amount}
     ]]>
    	<if test="keyword != null">
    		and CLASS_TITLE like '%'|| #{keyword} ||'%'
    	</if>
    <![CDATA[
         ) WHERE RNUM > (#{pageNum}-1) * #{amount} 
	]]>
	</select>
	
	
	<!--관심 챌린지 -->
   	<select id="getTotalCount_challengeLikeList" resultType="int">
	<![CDATA[
		select count(*) from likelist where user_id = #{userId} 
	]]>
	</select>


	<select id="getListWithPaging_challengeLikeList" parameterType="HashMap" resultMap="iClassMap">
	 <![CDATA[
	
		SELECT *
FROM
(
    SELECT ROWNUM rn, c.*
    FROM
    (
        SELECT B.*, A.likelist_id, A.board_id
        FROM iclass B,
        (
            SELECT *
            FROM likelist A
            WHERE user_id = #{userId}
        ) A
        WHERE A.class_id=B.class_id and A.user_id = #{userId} and B.category_id = 1 and CLASS_ENDDATE >= sysdate
        ORDER BY B.class_startdate DESC
    ) C
    WHERE rownum <= #{cri.pageNum} * #{cri.amount}
)
WHERE rn > (#{cri.pageNum}-1) * #{cri.amount}

	]]> 

	</select>
	
	
	<!-- 챌린지 시작일순 -->
	 <select id="getTotalCount_challengeStartList" resultType="int">
	<![CDATA[
		select count(*) from iclass where category_id = 1 and CLASS_ENDDATE >= sysdate order by class_startdate desc
	]]>
	</select>


	<select id="getListWithPaging_challengeStartList" resultMap="iClassMap">
	<![CDATA[
	SELECT * FROM (
    SELECT ROWNUM AS RNUM, A.* FROM (
        SELECT * FROM iclass where category_id = 1 and class_id > 0 and CLASS_ENDDATE >= sysdate order by class_startdate desc
             ) A WHERE ROWNUM <= #{pageNum} * #{amount}
         ) WHERE RNUM > (#{pageNum}-1) * #{amount}
	]]>
	</select>
	
	
	<!-- 챌린지 검색기능(제목으로만) -->
	<select id="searchTotalCount_challengeList" resultType="int">
	<![CDATA[
		select count(*) from iclass where category_id = 1 
	]]>
		<if test="keyword != null">
                    and title like '%'||#{keyword}||'%' 
        </if>
		
	
	</select>
	
	<select id="searchWithPaging_challengeList" resultMap="iClassMap">
	<![CDATA[
	SELECT * FROM (
    SELECT ROWNUM AS RNUM, A.* FROM (
        SELECT * FROM iclass where category_id = 1 and class_id > 0 order by class_enddate desc
             ) A WHERE ROWNUM <= #{pageNum} * #{amount} 
    ]]>
    	<if test="keyword != null">
    		and title like '%'||#{keyword}||'%'
    	</if>
    <![CDATA[
         ) WHERE RNUM > (#{pageNum}-1) * #{amount} 
	]]>
	</select>
	
	<!-- 챌린지 상세정보 불러오기 -->
	<select id="readChallengeInfo" resultMap="iClassMap">
		<![CDATA[
		SELECT * FROM ICLASS WHERE CATEGORY_ID = 1 and class_id > 0 AND CLASS_ENDDATE >= sysdate and CLASS_ID = #{classId}
	]]>
	</select>
	
	<!-- 챌린지 참여인원 update -->
   	<update id="upJoinMember">
	<![CDATA[
		update ICLASS set CLASS_JOINMEMBER = CLASS_JOINMEMBER+1 where CATEGORY_ID = 1 and class_id > 0 and class_joinmember <= class_totalmember and CLASS_ID = #{classId}
	]]>
	</update>
   

</mapper>